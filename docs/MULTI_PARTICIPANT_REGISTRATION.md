# 代報名功能使用說明

## 功能概述

代報名功能允許用戶為多人同時報名參加活動，並指定聯絡人接收通知。

## 後端配置

### 啟用代報名

在活動設定中設置 `max_participants_per_user` 欄位：

```json
{
  "max_participants_per_user": 3  // 允許最多為3人報名（包含自己）
}
```

- `max_participants_per_user = 1`：只能報名自己（預設）
- `max_participants_per_user > 1`：可以代報名，前端會顯示報名人數選擇器

## 前端功能

### 1. 報名人數選擇

當 `max_participants_per_user > 1` 時，會顯示下拉選單：

```
報名人數 *
┌─────────────────────────────────┐
│ ▼ 選擇報名人數                  │
│   - 1人                         │
│   - 2人（代報名1人）             │
│   - 3人（代報名2人）最多         │
└─────────────────────────────────┘
```

### 2. 參加者表單

每位參加者都有獨立的表單卡片：

```
┌─────────────────────────────────┐
│ 👤 參加者 1  [📧 聯絡人]         │
│                                 │
│ 姓名: [____________]            │
│ Email: [____________]           │
│ ... 完整的動態表單欄位 ...       │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 👤 參加者 2                      │
│                                 │
│ 姓名: [____________]            │
│ Email: [____________]           │
│ ... 完整的動態表單欄位 ...       │
└─────────────────────────────────┘
```

### 3. 聯絡人設定

多人報名時會顯示聯絡人選擇區塊：

```
┌─────────────────────────────────┐
│ 📧 聯絡人設定                    │
│ （將收到活動通知和確認信）        │
│                                 │
│ ○ 參加者 1 (張三)               │
│ ○ 參加者 2 (李四)               │
│ ○ 其他（請在下方備註欄填寫）     │
│                                 │
│ [如果選擇"其他"]                 │
│ 聯絡人資訊（備註）:              │
│ ┌─────────────────────────────┐ │
│ │ 請填寫姓名、電話、Email等...  │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

**預設行為**：
- 預設選擇「參加者 1」作為聯絡人
- 可以選擇任一參加者
- 可以選擇「其他」並在備註欄填寫聯絡資訊

### 4. 費用計算

費用會根據人數和每個人的選項自動計算：

```
💰 費用明細
────────────────────────────
基本費用 (2人)      NT$ 200
────────────────────────────
總計               NT$ 200
```

### 5. 防呆機制

1. **表單驗證**
   - 驗證每位參加者的所有必填欄位
   - 錯誤訊息會標明是哪位參加者：「參加者 2: 電子郵件為必填欄位」

2. **聯絡人驗證**
   - 如果選擇「其他」，備註欄必須填寫
   - 單人報名時自動設為聯絡人，無需選擇

3. **人數限制**
   - 不能超過 `max_participants_per_user`
   - 減少人數時會刪除多餘的參加者資料
   - 如果聯絡人被刪除，會自動重置為參加者 1

4. **價格計算**
   - 基本費用 = `base_price` × 人數
   - 額外費用 = 每位參加者的選項價格總和
   - 總計 = 基本費用 + 額外費用

## 資料提交格式

提交到後端的資料結構：

```json
{
  "items": [
    {
      "item_pk": 1217,
      "quantity": 2  // 報名人數
    }
  ],
  "payment_method": "LINEPay",
  "participant_info": {
    "participant_count": 2,
    "participants": [
      {
        "name": "張三",
        "email": "zhang@example.com",
        "phone": "0912345678",
        "workshops": ["ws_ai", "ws_brand"],
        "day_trip": "yes",
        "id_number": "A123456789",
        "agree_terms": true,
        "agree_privacy": true
      },
      {
        "name": "李四",
        "email": "li@example.com",
        "phone": "0987654321",
        "workshops": ["ws_marketing"],
        "day_trip": "no",
        "agree_terms": true,
        "agree_privacy": true
      }
    ],
    "primary_contact_index": 0,  // 0=第一人, 1=第二人, -1=其他
    "contact_note": ""           // 如果選擇"其他"，這裡會有聯絡資訊
  }
}
```

## 使用流程

### 用戶操作流程

1. **選擇報名人數**（如果允許代報名）
   - 選擇要報名的人數

2. **填寫參加者資訊**
   - 依序填寫每位參加者的完整表單
   - 每位參加者都可以有不同的選項（如：不同的工作坊場次）

3. **選擇聯絡人**（多人報名時）
   - 選擇其中一位參加者作為聯絡人
   - 或選擇「其他」並在備註欄填寫聯絡資訊

4. **確認費用**
   - 查看費用明細
   - 確認總金額

5. **選擇付款方式**（付費活動）
   - 選擇付款方式

6. **確認報名**
   - 系統會顯示確認對話框：
     ```
     確認報名
     
     報名人數：2人
     聯絡人：參加者 1
     活動費用：NT$ 200
     
     確定要提交報名嗎？
     ```

## 範例場景

### 場景 1：公司團報

**背景**：老闆為公司3位員工報名創業高峰會

1. 選擇「3人（代報名2人）」
2. 填寫3位員工的資料
3. 選擇自己（參加者 1）作為聯絡人
4. 每位員工選擇不同的工作坊場次
5. 總費用：NT$ 3,000（3人 × NT$ 1,000）

### 場景 2：家庭報名

**背景**：媽媽為一家人報名親子活動

1. 選擇「4人（代報名3人）」
2. 填寫爸爸、媽媽、2個小孩的資料
3. 選擇媽媽（參加者 2）作為聯絡人
4. 小孩選擇兒童餐，大人選擇成人餐
5. 加購：爸爸選擇停車位 +NT$ 100

### 場景 3：代朋友報名

**背景**：幫朋友報名但朋友想收通知

1. 選擇「2人（代報名1人）」
2. 填寫自己和朋友的資料
3. 選擇「其他」並填寫朋友的聯絡資訊
4. 提交報名

## 注意事項

1. **所有參加者都需要完整填寫表單**
   - 包括動態表單的所有必填欄位
   - 包括同意條款等系統欄位

2. **聯絡人設定很重要**
   - 聯絡人會收到所有通知和確認信
   - 確保聯絡資訊正確

3. **價格計算**
   - 每位參加者的選項都會影響總價
   - 費用明細會清楚列出所有項目

4. **減少人數會刪除資料**
   - 如果改變報名人數（減少），多餘的參加者資料會被刪除
   - 請謹慎操作

## 技術細節

### 組件結構

```
EventJoin.tsx (主頁面)
├── ParticipantFormCard (參加者表單卡片)
│   └── DynamicFormField (動態欄位)
├── 聯絡人選擇區塊
├── 費用明細
└── 付款方式
```

### 關鍵函數

- `handleParticipantCountChange(count)`: 處理人數變更
- `handleParticipantFieldChange(index, fieldId, value)`: 處理單個參加者的欄位變更
- `calculateTotalPrice()`: 計算所有參加者的總價格
- 表單驗證會逐一檢查每位參加者的資料

### 狀態管理

```typescript
const [participantCount, setParticipantCount] = useState(1);
const [participants, setParticipants] = useState<DynamicFormData[]>([{}]);
const [primaryContactIndex, setPrimaryContactIndex] = useState(0);
const [contactNote, setContactNote] = useState('');
```

## 常見問題

**Q: 如果不設定 `max_participants_per_user` 會怎樣？**  
A: 預設為 1，只能報名自己，不會顯示人數選擇器。

**Q: 可以為每位參加者設定不同的價格嗎？**  
A: 基本費用是固定的（`base_price` × 人數），但每位參加者可以選擇不同的加購項目，這些會累加到總價。

**Q: 聯絡人可以不是參加者之一嗎？**  
A: 可以，選擇「其他」並在備註欄填寫聯絡資訊即可。

**Q: 如果中途改變報名人數會怎樣？**  
A: 增加人數會添加新的空白表單；減少人數會刪除多餘的參加者資料（無法復原）。

